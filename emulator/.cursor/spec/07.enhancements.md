# Emulator Enhancements

This document outlines proposed and implemented enhancements for the Device Mock, focusing on improving the developer experience and testing capabilities.

## üé® UI Visualization

To provide a better "at-a-glance" view of the emulator's status without tailing logs, a simple web-based UI will be served locally by the emulator.

### UI Components

1.  **Status Ring:** A visual representation of the LED ring. This will be a colored circle with a thick border, matching the current `WorkStatus` color.
2.  **"Ask to Enter" Button:** A clickable button in the center of the ring. Clicking it will trigger the "Ask to Enter" WebSocket message to the Tray App, simulating a physical button press.
3.  **Status Info:** Text displaying the current status (e.g., "ON_CALL"), battery level, and connection state.

### Implementation Sketch

The UI will be a single HTML file with inline CSS and JavaScript, served via a simple HTTP server integrated into the emulator.

```html
<!-- public/index.html -->
<style>
  .ring {
    width: 150px;
    height: 150px;
    border-radius: 50%;
    border: 20px solid gray; /* Default color */
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .button {
    /* Styles for the button */
  }
</style>

<div id="status-ring" class="ring">
  <button id="ask-button" class="button">Ask to Enter</button>
</div>
<div id="status-info"></div>

<script>
  const ring = document.getElementById('status-ring');
  // WebSocket logic to update ring.style.borderColor
  // and button click handler
</script>
```

---

## üêû Advanced Error Simulation

To enable robust testing of the Tray App's resilience, the emulator's Test Controller API will be extended to simulate various failure scenarios.

### New Test Controller Methods

The `TestController` class (available in test mode) will expose new methods:

```typescript
// emulator/src/main/testController.ts

class TestController {
  // ... existing methods

  /**
   * Simulates a sudden disconnection of all WebSocket clients.
   */
  async simulateDisconnect(): Promise<void>;

  /**
   * Simulates an error during the serial port data transfer.
   */
  async simulatePairingError(): Promise<void>;

  /**
   * Simulates a gradual or sudden drop in battery level.
   * @param level The target battery level (0-100).
   */
  async simulateBatteryDrop(level: number): Promise<void>;

  /**
   * Simulates a device becoming completely unresponsive.
   */
  async simulateTimeout(): Promise<void>;
}
```

### E2E Test Scenarios

These new methods will allow for writing E2E tests for failure cases in the Tray App:

```typescript
// tray-app/e2e/tests/resilience.spec.ts

test('should handle device disconnect and reconnect', async ({ page }) => {
  // 1. Initial state: device is connected
  // 2. Simulate disconnect
  await mockDevice.simulateDisconnect();
  // 3. Assert that tray-app shows "offline" status
  // 4. Simulate reconnect
  // 5. Assert that tray-app shows "online" status again
});

test('should show error message on pairing failure', async ({ page }) => {
  // 1. Start pairing wizard
  // 2. Simulate pairing error
  await mockDevice.simulatePairingError();
  // 3. Assert that the pairing window shows an error message
});
```
