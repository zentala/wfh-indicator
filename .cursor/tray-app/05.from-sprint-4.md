# Nowy Plan Rozwoju Aplikacji (od Sprintu 4)

W związku z napotkanymi i udokumentowanymi w `04.issues.md` problemami z bibliotekami `electron-store` i `serialport`, podjęto decyzję o zmianie stosu technologicznego. Ten dokument opisuje nową architekturę i plan działania od tego momentu.

---

## 1. Zmiana Stosu Technologicznego

| Kategoria                 | Odrzucona technologia | Nowa technologia        | Uzasadnienie                                                                                                                                                                                         |
| ------------------------- | --------------------- | ----------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Przechowywanie Danych** | `electron-store`      | **`electron-settings`** | `electron-store` powoduje nierozwiązywalne konflikty z `electron-vite` i systemem modułów ES. `electron-settings` jest nowocześniejszą i bardziej kompatybilną alternatywą.                          |
| **Komunikacja Hardware**  | `serialport`          | **`node-serialport`**   | Chociaż to w dużej mierze ta sama biblioteka, użycie `node-serialport` zapewnia, że instalujemy pakiet przeznaczony bezpośrednio dla środowiska Node.js, co minimalizuje ryzyko dalszych konfliktów. |

---

## 2. Zaktualizowana Architektura i Przepływ Danych

Architektura pozostaje w dużej mierze zgodna z pierwotnym planem, z kluczową zmianą w module `DeviceManager`.

### `src/main/deviceManager.ts` (Nowa implementacja)

Moduł ten zostanie przepisany, aby korzystać z `electron-settings`. API jest bardzo podobne, co ułatwi migrację.

**Kluczowe zmiany:**
- Zamiast `new Store()`, będziemy używać bezpośrednio metod z `electron-settings` (np. `settings.get()` i `settings.set()`).
- Logika pozostaje ta sama: przechowywanie listy urządzeń i reguł harmonogramu.

**Przykład (pseudo-kod):**
```typescript
import settings from 'electron-settings';
import { DeviceInfo } from '../shared/types';

class DeviceManager {
  constructor() {
    // Ustawienie domyślnych wartości, jeśli nie istnieją
    if (!settings.has('devices')) {
      settings.set('devices', []);
    }
  }

  public async getDevices(): Promise<DeviceInfo[]> {
    return (await settings.get('devices')) as DeviceInfo[];
  }

  public async addDevice(device: Omit<DeviceInfo, 'id' | 'connected'>): Promise<DeviceInfo> {
    const devices = (await this.getDevices()) || [];
    const newDevice = { ... };
    await settings.set('devices', [...devices, newDevice]);
    return newDevice;
  }
}
```

---

## 3. Zaktualizowany Plan Scrum (od Sprintu 4)

Sprinty 1-3 pozostają bez zmian. Sprint 4 i kolejne zostają zredefiniowane.

### Sprint 4 (Restart): Czysta implementacja logiki parowania

**Cel Sprintu:** Wdrożenie pełnej logiki parowania w oparciu o nowe, stabilne biblioteki.

*   **Epik:** Device Management (Refactored)
*   **User Stories / Tasks:**
    - [ ] **Task 4.1 (Nowy):** Odinstalowanie `electron-store` i `serialport`.
    - [ ] **Task 4.2 (Nowy):** Zainstalowanie `electron-settings` i `node-serialport`.
    - [ ] **Task 4.3 (Nowy):** Refaktoryzacja `DeviceManager.ts` w celu użycia `electron-settings` do zarządzania danymi (CRUD dla urządzeń).
    - [ ] **Task 4.4 (Nowy):** Ponowna implementacja funkcji `detectUSBDevice` z użyciem `node-serialport`.
    - [ ] **Task 4.5:** Implementacja logiki transferu danych (SSID/hasło) przez port szeregowy do urządzenia.
    - [ ] **Task 4.6:** Implementacja logiki testowania połączenia – `DeviceManager` próbuje połączyć się z urządzeniem przez Wi-Fi po transferze.
    - [ ] **Task 4.7:** Implementacja kroku "potwierdzenia zielonego koloru" przez użytkownika (dialog w rendererze).
    - [ ] **Task 4.8:** Podłączenie nowej logiki z `DeviceManager` do kreatora parowania za pomocą kanałów IPC.
    - [ ] **Task 4.9 (Test):** Testy jednostkowe dla `DeviceManager` z mockowaniem `electron-settings` i `node-serialport`.
    - [ ] **Task 4.10 (Test):** Test E2E dla całego procesu parowania.

### Dalsze Sprinty (5, 6, 7)

Plan dla dalszych sprintów pozostaje **bez zmian**, ponieważ dotyczy on implementacji UI i logiki biznesowej, które nie są bezpośrednio zależne od wybranej biblioteki do przechowywania danych. Zmiana dotyczy tylko warstwy abstrakcji danych w `DeviceManager`.

---

## 4. Konieczne zmiany w dokumentacji

- Plik `.cursor/tray-app/03-arch.md` musi zostać zaktualizowany, aby odzwierciedlał zmianę w stosie technologicznym.
- Plik `.cursor/tray-app/02-scrum-plan.md` **nie będzie modyfikowany**. Zamiast tego, ten dokument (`05.from-sprint-4.md`) staje się nadrzędny w kwestii planu od Sprintu 4.

Ten dokument stanowi teraz oficjalny plan działania.

