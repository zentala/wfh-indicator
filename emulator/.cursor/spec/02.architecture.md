# Device Mock - Architecture

## 🏗️ Szczegółowa Architektura

### Komponenty Systemu

#### 1. DeviceMock (Główny Kontroler)
```typescript
class DeviceMock {
  private ledController: LEDController;
  private wifiManager: WiFiManager;
  private buttonHandler: ButtonHandler;
  private testMode: boolean;

  constructor(options: DeviceMockOptions) {
    this.testMode = options.testMode || false;
    this.ledController = new LEDController();
    this.wifiManager = new WiFiManager(options.port);
    this.buttonHandler = new ButtonHandler();
  }
}
```

#### 2. LEDController (Symulacja LED Ring)
```typescript
class LEDController {
  private currentColor: string;
  private brightness: number;
  private pattern: LEDPattern;

  setColor(color: string): void;
  setBrightness(level: number): void;
  setPattern(pattern: LEDPattern): void;
  animate(): void;
}
```

#### 3. WiFiManager (Komunikacja WebSocket)
```typescript
class WiFiManager {
  private server: WebSocket.Server;
  private clients: Set<WebSocket>;

  start(): void;
  broadcast(message: any): void;
  handleMessage(message: any): void;
}
```

#### 4. ButtonHandler (Symulacja Przycisku)
```typescript
class ButtonHandler {
  private pressTimeout: NodeJS.Timeout;
  private pressCount: number;

  handlePress(): void;
  handleLongPress(): void;
  handleDoublePress(): void;
}
```

## 🎨 Status System

### Work Status Colors
```typescript
enum WorkStatus {
  ON_CALL = 'red',      // 🔴 Audio/video calls
  VIDEO_CALL = 'orange', // 🟠 Video calls only
  FOCUSED = 'yellow',    // 🟡 Deep work
  AVAILABLE = 'green',   // 🟢 Available
  AWAY = 'blue',         // 🔵 Not at desk
  OFFLINE = 'gray'       // ⚫ Device offline
}
```

### LED Patterns
```typescript
interface LEDPattern {
  type: 'solid' | 'breathing' | 'pulse' | 'blink';
  color: string;
  brightness: number; // 0-100
  speed?: number;     // Animation speed
}
```

## 🔌 Komunikacja

### WebSocket Messages
```typescript
// Status Update from Tray App
interface StatusUpdate {
  type: 'status_update';
  status: WorkStatus;
  timestamp: number;
}

// Ask to Enter Request from Device
interface AskToEnterRequest {
  type: 'ask_to_enter';
  deviceId: string;
  urgency: 'normal' | 'urgent';
  timestamp: number;
}

// Ask to Enter Response from Tray App
interface AskToEnterResponse {
  type: 'ask_to_enter_response';
  deviceId: string;
  response: 'yes' | 'no' | 'if_urgent';
  timestamp: number;
}

// Battery Level Report from Device
interface BatteryReport {
  type: 'battery_report';
  deviceId: string;
  level: number; // 0-100
  charging: boolean;
  timestamp: number;
}
```

### Serial Communication (Pairing)
```typescript
// WiFi Credentials during Pairing
interface WiFiCredentials {
  ssid: string;
  password: string;
  security: 'WPA2' | 'WPA3' | 'OPEN';
}

// Pairing Status
interface PairingStatus {
  status: 'connecting' | 'connected' | 'failed';
  message: string;
}
```

## 🔄 Przepływ Danych

### 1. Status Update Flow
```
Tray App → WebSocket → WiFiManager → LEDController → LED Display
```

### 2. Ask to Enter Flow
```
Button Press → ButtonHandler → WiFiManager → Tray App → Response → LED Feedback
```

### 3. Pairing Flow
```
Serial Data → SerialUtils → WiFiManager → Connection Test → LED Confirmation
```

## 🧪 Test Mode Architecture

### Test Controller
```typescript
class TestController {
  private mockDevice: DeviceMock;

  async pressButton(type: 'single' | 'long' | 'double'): Promise<void>;
  async receiveSerialData(data: WiFiCredentials): Promise<void>;
  async sendAskToEnterRequest(urgency: 'normal' | 'urgent'): Promise<void>;
  async getLEDStatus(): Promise<{ color: string; brightness: number }>;
  async getLastResponse(): Promise<'yes' | 'no' | 'if_urgent'>;
}
```

### Test Mode Integration
```typescript
class DeviceMock {
  private testMode: boolean;
  private testController: TestController;

  constructor(options: { testMode?: boolean }) {
    this.testMode = options.testMode || false;
    if (this.testMode) {
      this.testController = new TestController(this);
    }
  }
}
```

## 📦 Dependencies

### Production Dependencies
```json
{
  "ws": "^8.14.2",           // WebSocket server
  "serialport": "^12.0.0",    // Serial communication
  "chalk": "^5.3.0"          // Console colors
}
```

### Development Dependencies
```json
{
  "@types/ws": "^8.5.10",
  "@types/jest": "^29.5.8",
  "jest": "^29.7.0",
  "typescript": "^5.2.2",
  "eslint": "^8.55.0",
  "prettier": "^3.1.0"
}
```

## 🔧 Konfiguracja

### Environment Variables
```bash
MOCK_PORT=8080              # WebSocket server port
MOCK_SERIAL_PORT=/dev/ttyUSB0  # Serial port simulation
MOCK_TEST_MODE=false        # Test mode flag
MOCK_DEBUG=false           # Debug mode flag
```

### Configuration Interface
```typescript
interface DeviceMockConfig {
  port?: number;
  serialPort?: string;
  testMode?: boolean;
  debug?: boolean;
  batteryLevel?: number;
  charging?: boolean;
}
```

## 🚀 Performance Considerations

### Memory Management
- WebSocket connections cleanup
- Event listener cleanup
- Timer cleanup
- Resource pooling

### Network Optimization
- Message batching
- Connection pooling
- Error retry mechanisms
- Timeout handling

### CPU Optimization
- Efficient LED animations
- Debounced button handling
- Optimized message processing
- Background task management

---

**Note**: Ta architektura zapewnia modularność, testowalność i łatwość rozszerzania funkcjonalności.
