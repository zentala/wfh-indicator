# Device Mock - Integration with Tray App

## ğŸ”— Integracja z Tray App

### ğŸ¯ Cel Integracji

Mock urzÄ…dzenia jest kluczowy dla ukoÅ„czenia testÃ³w E2E w tray-app, szczegÃ³lnie dla zadaÅ„:
- **Task 4.15**: Test E2E dla procesu parowania
- **Task 6.7**: Test E2E dla "Ask to Enter"

### ğŸ—ï¸ Architektura Integracji

#### Struktura TestÃ³w E2E z Mockiem
```
tray-app/
â”œâ”€â”€ e2e/
â”‚   â”œâ”€â”€ device-mock/
â”‚   â”‚   â”œâ”€â”€ mock-server.ts      # Serwer mocka urzÄ…dzenia
â”‚   â”‚   â”œâ”€â”€ mock-controller.ts  # API do kontrolowania mocka
â”‚   â”‚   â””â”€â”€ mock-scenarios.ts   # Predefiniowane scenariusze
â”‚   â”œâ”€â”€ tests/
â”‚   â”‚   â”œâ”€â”€ pairing.spec.ts     # Test parowania
â”‚   â”‚   â”œâ”€â”€ ask-to-enter.spec.ts # Test powiadomieÅ„
â”‚   â”‚   â””â”€â”€ status-updates.spec.ts # Test aktualizacji statusu
â”‚   â””â”€â”€ utils/
â”‚       â””â”€â”€ mock-helper.ts      # Helpery do testÃ³w
```

#### Mock Controller API
```typescript
// API do kontrolowania mocka w testach E2E
class MockDeviceController {
  // Symulacja przycisku fizycznego
  async pressButton(type: 'single' | 'long' | 'double'): Promise<void>;

  // Symulacja komunikacji szeregowej
  async receiveSerialData(data: WiFiCredentials): Promise<void>;

  // Symulacja Å¼Ä…dania "Ask to Enter"
  async sendAskToEnterRequest(urgency: 'normal' | 'urgent'): Promise<void>;

  // Sprawdzenie stanu LED
  async getLEDStatus(): Promise<{ color: string; brightness: number }>;

  // Sprawdzenie ostatniej odpowiedzi
  async getLastResponse(): Promise<'yes' | 'no' | 'if_urgent'>;
}
```

### ğŸ“‹ Scenariusze Testowe

#### A. Test Parowania (Task 4.15)
```typescript
test('Complete pairing flow with mock device', async ({ page }) => {
  // 1. OtwÃ³rz kreator parowania
  await page.click('[data-testid="add-device"]');

  // 2. Mock odbiera SSID/password przez Serial
  await mockDevice.receiveSerialData({
    ssid: 'TestWiFi',
    password: 'test123'
  });

  // 3. Mock Å‚Ä…czy siÄ™ przez WiFi
  await mockDevice.connectToWiFi();

  // 4. Mock potwierdza parowanie (zielony LED)
  await mockDevice.confirmPairing();

  // 5. SprawdÅº czy urzÄ…dzenie pojawiÅ‚o siÄ™ na liÅ›cie
  await expect(page.locator('[data-testid="device-list"]'))
    .toContainText('LED Device #1');
});
```

#### B. Test "Ask to Enter" (Task 6.7)
```typescript
test('Ask to Enter notification flow', async ({ page }) => {
  // 1. Mock wysyÅ‚a Å¼Ä…danie "Ask to Enter"
  await mockDevice.sendAskToEnterRequest({
    deviceId: 'device-1',
    urgency: 'normal'
  });

  // 2. SprawdÅº czy powiadomienie siÄ™ pojawiÅ‚o
  await expect(page.locator('[data-testid="notification"]'))
    .toContainText('Ask to Enter');

  // 3. Kliknij "Yes" w powiadomieniu
  await page.click('[data-testid="notification-yes"]');

  // 4. SprawdÅº czy odpowiedÅº zostaÅ‚a wysÅ‚ana do mocka
  await expect(mockDevice.getLastResponse()).toBe('yes');
});
```

### ğŸ”§ Implementacja Techniczna

#### Mock w Trybie Testowym
```typescript
// emulator/src/main/deviceMock.ts
class DeviceMock {
  private testMode: boolean = false;
  private testController: TestController;

  constructor(options: { testMode?: boolean }) {
    this.testMode = options.testMode || false;
    if (this.testMode) {
      this.testController = new TestController();
    }
  }

  // API dla testÃ³w E2E
  async simulateButtonPress(type: 'single' | 'long' | 'double'): Promise<void> {
    if (!this.testMode) return;

    switch (type) {
      case 'single':
        await this.sendAskToEnterRequest('normal');
        break;
      case 'long':
        await this.enterPairingMode();
        break;
    }
  }
}
```

#### Integracja z Playwright
```typescript
// tray-app/e2e/utils/mock-helper.ts
export class MockHelper {
  private mockController: MockDeviceController;

  async setupMock(): Promise<void> {
    // Uruchom mock urzÄ…dzenia
    this.mockController = new MockDeviceController({
      port: 8080,
      serialPort: '/dev/ttyUSB0'
    });
    await this.mockController.start();
  }

  async simulateDeviceAction(action: DeviceAction): Promise<void> {
    switch (action.type) {
      case 'button_press':
        await this.mockController.pressButton(action.buttonType);
        break;
      case 'ask_to_enter':
        await this.mockController.sendAskToEnterRequest(action.urgency);
        break;
    }
  }
}
```

### ğŸ“‹ Plan Integracji

#### Phase 1: Podstawowa Integracja
- [ ] Mock urzÄ…dzenia z trybem testowym
- [ ] API do kontrolowania mocka
- [ ] Integracja z Playwright testami
- [ ] Podstawowe scenariusze testowe

#### Phase 2: Zaawansowane Scenariusze
- [ ] Testy parowania z rÃ³Å¼nymi scenariuszami bÅ‚Ä™dÃ³w
- [ ] Testy "Ask to Enter" z rÃ³Å¼nymi poziomami pilnoÅ›ci
- [ ] Testy aktualizacji statusu w czasie rzeczywistym
- [ ] Testy obsÅ‚ugi bÅ‚Ä™dÃ³w komunikacji

#### Phase 3: Optymalizacja
- [ ] Automatyzacja uruchamiania mocka w CI/CD
- [ ] Parallel test execution z wieloma mockami
- [ ] Performance testing z symulacjÄ… wielu urzÄ…dzeÅ„

### ğŸ¯ KorzyÅ›ci z Integracji

1. **Realistyczne Testy** - Mock symuluje prawdziwe zachowanie urzÄ…dzenia
2. **Kontrola Scenariuszy** - MoÅ¼emy testowaÄ‡ rÃ³Å¼ne sytuacje (bÅ‚Ä™dy, timeouty)
3. **Izolacja TestÃ³w** - Nie zaleÅ¼ymy od prawdziwego hardware
4. **Szybkie Iteracje** - Testy dziaÅ‚ajÄ… bez fizycznego urzÄ…dzenia
5. **CI/CD Friendly** - Mock moÅ¼e dziaÅ‚aÄ‡ w Å›rodowisku CI/CD

### ğŸ”— Komunikacja z Tray App

#### WebSocket Communication
```typescript
// Mock wysyÅ‚a status do tray app
await mockDevice.sendStatusUpdate({
  type: 'status_update',
  status: WorkStatus.AVAILABLE,
  timestamp: Date.now()
});

// Mock odbiera status od tray app
mockDevice.onStatusUpdate((status: WorkStatus) => {
  this.ledController.setColor(status);
});
```

#### Serial Communication (Pairing)
```typescript
// Mock odbiera dane WiFi podczas parowania
mockDevice.onSerialData((data: WiFiCredentials) => {
  this.wifiManager.connect(data.ssid, data.password);
});
```

### ğŸš€ Setup Instructions

#### 1. Instalacja Mocka
```bash
# W folderze emulator
cd emulator
pnpm install
pnpm build
```

#### 2. Konfiguracja Tray App
```bash
# W folderze tray-app
cd tray-app
pnpm install
```

#### 3. Uruchomienie TestÃ³w E2E
```bash
# Terminal 1: Uruchom mock
cd emulator
pnpm start:mock

# Terminal 2: Uruchom testy E2E
cd tray-app
pnpm test:e2e
```

### ğŸ“Š Metryki Integracji

#### Technical Metrics
- **Test Coverage**: >90% dla funkcjonalnoÅ›ci komunikacji z urzÄ…dzeniem
- **Performance**: <100ms response time dla status updates
- **Reliability**: 99.9% uptime podczas testing sessions
- **Compatibility**: DziaÅ‚a z obecnÄ… tray app bez modyfikacji

#### Development Metrics
- **Code Quality**: ESLint score >95%
- **Documentation**: JSDoc coverage dla wszystkich publicznych API
- **Maintainability**: Jasne oddzielenie odpowiedzialnoÅ›ci, modularny design

### ğŸš¨ Troubleshooting

#### Common Issues

##### Port Already in Use
```bash
# SprawdÅº czy port 8080 jest zajÄ™ty
lsof -i :8080

# Zabij proces uÅ¼ywajÄ…cy port
kill -9 <PID>
```

##### Mock Not Starting
```bash
# SprawdÅº logi
cd emulator
pnpm start:mock --debug

# SprawdÅº zaleÅ¼noÅ›ci
pnpm install
```

##### Test Connection Issues
```typescript
// SprawdÅº poÅ‚Ä…czenie WebSocket
const ws = new WebSocket('ws://localhost:8080');
ws.onopen = () => console.log('Connected');
ws.onerror = (error) => console.error('Connection failed:', error);
```

### ğŸ“ Best Practices

#### 1. Test Isolation
```typescript
beforeEach(async () => {
  // Reset mock state before each test
  await mockDevice.reset();
});
```

#### 2. Error Handling
```typescript
try {
  await mockDevice.start();
} catch (error) {
  console.error('Failed to start mock:', error);
  // Fallback to mock mode
}
```

#### 3. Performance Monitoring
```typescript
// Monitor response times
const startTime = Date.now();
await mockDevice.sendAskToEnterRequest('normal');
const responseTime = Date.now() - startTime;
console.log(`Response time: ${responseTime}ms`);
```

---

**Note**: Ta integracja umoÅ¼liwia ukoÅ„czenie wszystkich testÃ³w E2E w tray-app bez potrzeby posiadania prawdziwego hardware, jednoczeÅ›nie zapewniajÄ…c realistyczne testowanie komunikacji z urzÄ…dzeniem.
