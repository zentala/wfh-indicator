
# Architektura Aplikacji: WFH Indicator Tray App

Ten dokument opisuje architekturÄ™ technicznÄ… i kluczowe decyzje projektowe dla aplikacji `wfh-indicator/tray-app`, bazujÄ…c na ustaleniach z plikÃ³w `01-init.md` (wizja produktu) i `02-scrum-plan.md` (plan wdroÅ¼enia).

## 1. Wprowadzenie i Filozofia

Aplikacja jest budowana w oparciu o Electron. Kluczowe zaÅ‚oÅ¼enia architektoniczne to:

*   **ModularnoÅ›Ä‡ i ReuÅ¼ywalnoÅ›Ä‡:** Dzielenie kodu na maÅ‚e, reuÅ¼ywalne komponenty (React) i moduÅ‚y (TypeScript).
*   **Separacja KontekstÃ³w:** Rygorystyczne oddzielenie logiki **procesu gÅ‚Ã³wnego** (`main`) od logiki **procesu renderera** (`renderer`). Komunikacja odbywa siÄ™ wyÅ‚Ä…cznie przez bezpieczne kanaÅ‚y IPC.
*   **SkalowalnoÅ›Ä‡:** Struktura zaprojektowana z myÅ›lÄ… o Å‚atwym dodawaniu nowych funkcji.
*   **TestowalnoÅ›Ä‡:** Architektura uwzglÄ™dniajÄ…ca Å‚atwoÅ›Ä‡ pisania testÃ³w jednostkowych i E2E.

## 2. Stos Technologiczny (Tech Stack) - ZAKTUALIZOWANY

| Kategoria                 | Wybrana technologia        | Status | Uzasadnienie                                                                                                                     |
| ------------------------- | -------------------------- | ------ | -------------------------------------------------------------------------------------------------------------------------------- |
| **Framework Aplikacji**   | **Electron**               | âœ…      | Standard do budowy aplikacji desktopowych z uÅ¼yciem JS/TS, HTML, CSS.                                                            |
| **JÄ™zyk programowania**   | **TypeScript**             | âœ…      | Zapewnia bezpieczeÅ„stwo typÃ³w, lepszÄ… jakoÅ›Ä‡ kodu i Å‚atwiejszÄ… refaktoryzacjÄ™.                                                   |
| **Framework UI**          | **React**                  | âœ…      | Popularny, wydajny i oparty na komponentach framework do budowy interfejsÃ³w uÅ¼ytkownika.                                         |
| **Styling**               | **Tailwind CSS + DaisyUI** | âœ…      | Tailwind (utility-first) do precyzyjnego stylowania, DaisyUI do gotowych komponentÃ³w (przyciski, taby).                          |
| **MenedÅ¼er PakietÃ³w**     | **PNPM**                   | âœ…      | Szybki i wydajny pod wzglÄ™dem zuÅ¼ycia miejsca na dysku.                                                                          |
| **Przechowywanie Danych** | **`electron-settings`**    | âœ…      | Nowoczesna biblioteka do zarzÄ…dzania trwaÅ‚ym stanem aplikacji. ZastÄ…piÅ‚a `electron-store` z powodu problemÃ³w z kompatybilnoÅ›ciÄ…. |
| **Logowanie**             | **`electron-log`**         | âœ…      | Niezawodne logowanie zdarzeÅ„ aplikacji do plikÃ³w, kluczowe dla diagnostyki i debugowania.                                        |
| **Aktualizacje**          | **`electron-updater`**     | âœ…      | Zapewnia mechanizm automatycznych aktualizacji aplikacji.                                                                        |
| **Komunikacja Hardware**  | **`serialport` (mock)**    | âš ï¸      | Biblioteka do komunikacji z urzÄ…dzeniami przez port szeregowy. Obecnie uÅ¼ywamy mocka z powodu problemÃ³w z kompilacjÄ….            |

## 3. RozwiÄ…zane Problemy Techniczne

### âœ… Problem 1: Konflikty z `electron-store`
**RozwiÄ…zanie:** ZastÄ…piono `electron-store` przez `electron-settings`
**Status:** WYKONANE - aplikacja uruchamia siÄ™ bez bÅ‚Ä™dÃ³w
**Jak przywrÃ³ciÄ‡:** NIE PRZYWRACAÄ† - `electron-settings` jest lepszÄ… alternatywÄ…

### âœ… Problem 2: Kompilacja natywnych moduÅ‚Ã³w `serialport`
**RozwiÄ…zanie:** Dodano mock `SerialPort` i konfiguracjÄ™ `@rollup/plugin-commonjs`
**Status:** WYKONANE - aplikacja uruchamia siÄ™ bez bÅ‚Ä™dÃ³w kompilacji
**Jak przywrÃ³ciÄ‡ prawdziwy `serialport`:**
```bash
# 1. Zaktualizuj g++ do wersji obsÅ‚ugujÄ…cej -std=gnu++20
sudo apt update && sudo apt install g++-11

# 2. Ustaw zmiennÄ… Å›rodowiskowÄ…
export CC=gcc-11
export CXX=g++-11

# 3. UsuÅ„ mock z deviceManager.ts i zainstaluj prawdziwy serialport
pnpm install serialport

# 4. Zbuduj ponownie
pnpm rebuild
```

### âœ… Problem 3: Konfiguracja Vite dla moduÅ‚Ã³w CommonJS
**RozwiÄ…zanie:** Dodano konfiguracjÄ™ `@rollup/plugin-commonjs` w `electron.vite.config.ts`
**Status:** WYKONANE - proces budowania dziaÅ‚a poprawnie

### âœ… Problem 4: Eksport funkcji `createPairingWindow`
**RozwiÄ…zanie:** Dodano eksport funkcji w `ipcHandlers.ts`
**Status:** WYKONANE - aplikacja uruchamia siÄ™ bez bÅ‚Ä™dÃ³w importu

## 4. Ikony i Assets

### Ikony Tray
**Status:** âš ï¸ BRAKUJÄ„CE - utworzono tylko SVG, brak PNG
**RozwiÄ…zanie:** UÅ¼yj Lucide Icons lub podobnego zestawu
```bash
# Instalacja Lucide Icons
pnpm add lucide-react

# Lub uÅ¼yj gotowych ikon PNG
# UtwÃ³rz ikony 16x16px dla kaÅ¼dego statusu: red, orange, yellow, green, blue, gray
```

### Struktura Ikon
```
public/icons/
â”œâ”€â”€ circle-red.png     # ON_CALL
â”œâ”€â”€ circle-orange.png  # VIDEO_CALL
â”œâ”€â”€ circle-yellow.png  # FOCUSED
â”œâ”€â”€ circle-green.png   # AVAILABLE
â”œâ”€â”€ circle-blue.png    # AWAY
â””â”€â”€ circle-gray.png    # OFFLINE
```

## 5. Struktura Projektu (Folder Structure)

Struktura folderÃ³w jest zaprojektowana w celu utrzymania porzÄ…dku i jasnego podziaÅ‚u odpowiedzialnoÅ›ci.

```text
wfh-indicator/
â””â”€â”€ tray-app/
    â”œâ”€â”€ src/
    â”‚   â”œâ”€â”€ main/
    â”‚   â”‚   â”œâ”€â”€ deviceManager.ts    # ZarzÄ…dzanie urzÄ…dzeniami (z mockiem SerialPort)
    â”‚   â”‚   â”œâ”€â”€ stateManager.ts     # ZarzÄ…dzanie statusem
    â”‚   â”‚   â”œâ”€â”€ ipcHandlers.ts      # ObsÅ‚uga komunikacji IPC
    â”‚   â”‚   â”œâ”€â”€ tray.ts             # Tray icon i menu
    â”‚   â”‚   â””â”€â”€ index.ts            # Punkt wejÅ›cia aplikacji
    â”‚   â”œâ”€â”€ renderer/
    â”‚   â”‚   â”œâ”€â”€ components/         # Komponenty React
    â”‚   â”‚   â”œâ”€â”€ utils/              # NarzÄ™dzia pomocnicze
    â”‚   â”‚   â””â”€â”€ App.tsx             # GÅ‚Ã³wny komponent UI
    â”‚   â””â”€â”€ shared/
    â”‚       â””â”€â”€ types.ts            # Definicje kluczowych interfejsÃ³w i typÃ³w
    â”œâ”€â”€ e2e/                        # Testy end-to-end
    â”œâ”€â”€ public/
    â”‚   â””â”€â”€ icons/                  # Ikony tray (PNG)
    â”œâ”€â”€ electron.vite.config.ts     # Konfiguracja Vite
    â”œâ”€â”€ package.json
    â”œâ”€â”€ tsconfig.json
    â””â”€â”€ pnpm-lock.yaml
```

## 6. Proces Budowania i Uruchamiania

*   **NarzÄ™dzie do budowania (Build Tool):** `electron-vite` dla nowoczesnego i szybkiego developmentu z HMR.
*   **NarzÄ™dzie do pakowania (Packager):** **Electron Forge** do tworzenia instalatorÃ³w (`.exe` dla Windows). To standardowe i najÅ‚atwiejsze rozwiÄ…zanie.
*   **Uruchamianie:** `pnpm start` (tryb deweloperski), `pnpm make` (budowanie paczki produkcyjnej).

## 7. Strategia Testowania

### Testy Jednostkowe (Unit Tests)

*   **Framework:** **Vitest**.
*   **Uzasadnienie:** Szybki, nowoczesny, kompatybilny z API Jest. Åatwy w uÅ¼yciu, dobrze integruje siÄ™ z Vite.
*   **Co testujemy:** LogikÄ™ w `main` (np. `deviceManager.ts` z mockowaniem `serialport`), komponenty React i funkcje pomocnicze w `renderer`.

### Testy End-to-End (E2E)

*   **Framework:** **Playwright**.
*   **Uzasadnienie:** Nowoczesne narzÄ™dzie od Microsoftu z doskonaÅ‚ym wsparciem dla Electron. Najlepsze i zalecane rozwiÄ…zanie.
*   **Co testujemy:** PeÅ‚ne Å›cieÅ¼ki uÅ¼ytkownika, takie jak zmiana statusu, parowanie urzÄ…dzenia, dodawanie reguÅ‚y harmonogramu.

## 8. Przechowywanie Danych (Data Persistence)

Aplikacja musi przechowywaÄ‡ dane konfiguracyjne miÄ™dzy uruchomieniami. Do tego celu uÅ¼ywamy biblioteki **`electron-settings`**.

*   **Dlaczego `electron-settings`?**
    *   Jest to nowoczeÅ›niejsza alternatywa dla `electron-store`.
    *   Automatycznie zarzÄ…dza tworzeniem i odczytem pliku konfiguracyjnego w odpowiednim dla systemu operacyjnego miejscu.
    *   Zapewnia bezpieczeÅ„stwo operacji zapisu (atomowoÅ›Ä‡), co chroni przed uszkodzeniem pliku konfiguracyjnego.
    *   RozwiÄ…zuje problemy z kompatybilnoÅ›ciÄ… z `electron-vite`.
*   **Jakie dane sÄ… przechowywane?**
    *   **Sparowane urzÄ…dzenia:** Lista identyfikatorÃ³w i nazw urzÄ…dzeÅ„.
    *   **ReguÅ‚y harmonogramu:** Wszystkie utworzone przez uÅ¼ytkownika reguÅ‚y automatycznej zmiany statusu.
    *   **Ustawienia uÅ¼ytkownika:** Wszelkie inne ustawienia, ktÃ³re mogÄ… pojawiÄ‡ siÄ™ w przyszÅ‚oÅ›ci.

## 9. Model Danych i WspÃ³Å‚dzielone Typy (Data Model & Shared Types)

Aby zapewniÄ‡ spÃ³jnoÅ›Ä‡ i bezpieczeÅ„stwo typÃ³w miÄ™dzy procesem gÅ‚Ã³wnym a rendererem, wszystkie kluczowe struktury danych sÄ… zdefiniowane w pliku `src/shared/types.ts`.

```typescript
// src/shared/types.ts

/**
 * Definiuje moÅ¼liwe statusy pracy uÅ¼ytkownika.
 */
export type WorkStatus = 'ON_CALL' | 'VIDEO_CALL' | 'FOCUSED' | 'AVAILABLE' | 'AWAY' | 'OFFLINE';

/**
 * Reprezentuje pojedyncze sparowane urzÄ…dzenie wskaÅºnikowe.
 */
export interface DeviceInfo {
  id: string;          // Unikalny identyfikator urzÄ…dzenia (np. numer seryjny)
  name: string;        // Nazwa nadana przez uÅ¼ytkownika (np. "Drzwi do biura")
  connected: boolean;  // Status poÅ‚Ä…czenia (online/offline)
  battery: number;     // Poziom naÅ‚adowania baterii w procentach (0-100)
}

/**
 * Definiuje strukturÄ™ pojedynczej reguÅ‚y harmonogramu.
 */
export interface ScheduleRule {
  id: string;                   // Unikalny identyfikator reguÅ‚y
  days: (1 | 2 | 3 | 4 | 5 | 6 | 7)[]; // Dni tygodnia (1=PoniedziaÅ‚ek, 7=Niedziela)
  startTime: string;            // Czas rozpoczÄ™cia w formacie "HH:mm"
  endTime: string;              // Czas zakoÅ„czenia w formacie "HH:mm"
  status: WorkStatus;           // Status do ustawienia
  enabled: boolean;             // Czy reguÅ‚a jest aktywna
}
```

## 10. BezpieczeÅ„stwo i Komunikacja MiÄ™dzyprocesowa (IPC)

Kluczowym aspektem bezpieczeÅ„stwa w aplikacjach Electron jest Å›cisÅ‚e oddzielenie procesu gÅ‚Ã³wnego (`main`) od procesÃ³w renderera (UI). Proces renderera nigdy nie moÅ¼e mieÄ‡ bezpoÅ›redniego dostÄ™pu do moduÅ‚Ã³w Node.js. Komunikacja odbywa siÄ™ przez bezpieczny most (`contextBridge`) tworzony w skrypcie `preload.js`.

**PrzepÅ‚yw komunikacji:**
1.  **`main/ipcHandlers.ts`**: Definiuje logikÄ™, ktÃ³ra ma byÄ‡ wykonana (np. odczyt pliku, parowanie urzÄ…dzenia).
2.  **`preload.js`**: Rejestruje bezpieczne funkcje i wystawia je procesowi renderera w obiekcie `window.api`. UÅ¼ywa `contextBridge`, aby uniknÄ…Ä‡ wycieku API do globalnego obiektu `window`.
3.  **`renderer/components/*.tsx`**: Komponenty React wywoÅ‚ujÄ… funkcje z `window.api` (np. `window.api.getDevices()`), aby bezpiecznie komunikowaÄ‡ siÄ™ z procesem gÅ‚Ã³wnym.

**PrzykÅ‚ad (`preload.js`):**
```javascript
const { contextBridge, ipcRenderer } = require('electron');

contextBridge.exposeInMainWorld('api', {
  // Bezpieczne wywoÅ‚anie funkcji, ktÃ³ra zwraca wartoÅ›Ä‡ (invoke/handle)
  getDevices: () => ipcRenderer.invoke('get-devices'),
  // Bezpieczne wysÅ‚anie jednokierunkowego komunikatu (send)
  setStatus: (status) => ipcRenderer.send('set-status', status),
});
```

## 11. ZarzÄ…dzanie Stanem Globalnym UI

Dla unikniÄ™cia nadmiernej zÅ‚oÅ¼onoÅ›ci zwiÄ…zanej z bibliotekami takimi jak Redux, stan globalny UI (np. lista urzÄ…dzeÅ„, aktualny status) jest zarzÄ…dzany przy uÅ¼yciu wbudowanego w React mechanizmu **Context API**.

*   Zostanie stworzony jeden gÅ‚Ã³wny `AppContext`.
*   Dostawca (`AppContext.Provider`) obejmie caÅ‚Ä… aplikacjÄ™ w `renderer/App.tsx`.
*   Komponenty, ktÃ³re potrzebujÄ… dostÄ™pu do stanu globalnego, uÅ¼yjÄ… hooka `useContext(AppContext)`.

To podejÅ›cie jest wystarczajÄ…co wydajne dla naszej aplikacji i znaczÄ…co upraszcza logikÄ™ przepÅ‚ywu danych wewnÄ…trz UI.

## 12. Automatyczne Aktualizacje

Aplikacja bÄ™dzie wyposaÅ¼ona w mechanizm cichych aktualizacji w tle.

*   **NarzÄ™dzie:** `electron-updater` (czÄ™Å›Ä‡ ekosystemu `electron-builder`, ktÃ³ry jest uÅ¼ywany przez `electron-forge`).
*   **Dostawca:** Aktualizacje bÄ™dÄ… publikowane na serwerze WWW. Konfiguracja wskaÅ¼e na adres URL oparty o TwojÄ… domenÄ™.
*   **Konfiguracja `package.json` (przykÅ‚ad):**
    ```json
    "build": {
      "publish": {
        "provider": "generic",
        "url": "https://wfh.zentala.io/updates"
      }
    }
    ```
*   **Proces:** Aplikacja po uruchomieniu bÄ™dzie sprawdzaÄ‡ w tle, czy na serwerze znajduje siÄ™ nowsza wersja. JeÅ›li tak, pobierze jÄ… i zainstaluje przy nastÄ™pnym restarcie.

## 13. Kluczowe Decyzje Architektoniczne - Podsumowanie

| Kategoria                 | Decyzja                                          | Status | Uzasadnienie                                                                              |
| ------------------------- | ------------------------------------------------ | ------ | ----------------------------------------------------------------------------------------- |
| **MenedÅ¼er pakietÃ³w**     | `pnpm`                                           | âœ…      | SzybkoÅ›Ä‡ i efektywne zarzÄ…dzanie miejscem na dysku.                                       |
| **Build & Dev Tool**      | `electron-vite`                                  | âœ…      | Nowoczesne, szybkie Å›rodowisko deweloperskie z HMR.                                       |
| **Pakowanie aplikacji**   | `electron-forge`                                 | âœ…      | Oficjalny standard, kompleksowe narzÄ™dzie do tworzenia instalatorÃ³w.                      |
| **Testy jednostkowe**     | `Vitest`                                         | âœ…      | Szybki, nowoczesny, Å‚atwy w uÅ¼yciu i dobrze zintegrowany ze stosem.                       |
| **Testy E2E**             | `Playwright`                                     | âœ…      | Najlepsze w swojej klasie narzÄ™dzie do E2E dla Electron, potÄ™Å¼ne i niezawodne.            |
| **TrwaÅ‚oÅ›Ä‡ danych**       | `electron-settings`                              | âœ…      | Nowoczesna biblioteka, rozwiÄ…zuje problemy z `electron-store`.                            |
| **Logowanie**             | `electron-log`                                   | âœ…      | Niezawodne logowanie zdarzeÅ„ aplikacji do plikÃ³w, kluczowe dla diagnostyki i debugowania. |
| **Aktualizacje**          | `electron-updater`                               | âœ…      | Zapewnia mechanizm automatycznych aktualizacji aplikacji.                                 |
| **Komunikacja ProcesÃ³w**  | Bezpieczne IPC z `contextBridge`                 | âœ…      | Standardowa, bezpieczna metoda komunikacji miÄ™dzy `main` a `renderer`.                    |
| **ZarzÄ…dzanie stanem UI** | Wbudowane hooki React (`useState`, `useContext`) | âœ…      | WystarczajÄ…ce dla prostoty obecnych okien, unikanie nadmiarowych zaleÅ¼noÅ›ci.              |
| **Komunikacja Hardware**  | `serialport` (mock)                              | âš ï¸      | Tymczasowe rozwiÄ…zanie, prawdziwa implementacja w przyszÅ‚oÅ›ci.                            |

## 14. Aktualny Status Implementacji

**âœ… Aplikacja uruchomiona pomyÅ›lnie**
- Proces Electron dziaÅ‚a bez bÅ‚Ä™dÃ³w
- Wszystkie zaleÅ¼noÅ›ci zainstalowane poprawnie
- Mock `SerialPort` dziaÅ‚a bez problemÃ³w
- `electron-settings` dziaÅ‚a poprawnie
- Konfiguracja Vite rozwiÄ…zuje problemy z moduÅ‚ami CommonJS

**ğŸ¯ Gotowe do dalszego rozwoju**
- Sprint 4: 7/15 zadaÅ„ wykonanych
- NastÄ™pne kroki: implementacja prawdziwej komunikacji przez port szeregowy
- UI kreatora parowania gotowy do integracji z logikÄ…

**âš ï¸ Do rozwiÄ…zania**
- Ikony tray (PNG) - uÅ¼yj Lucide Icons
- Prawdziwa implementacja `serialport` - zaktualizuj g++ do wersji 11+

| **Komunikacja ProcesÃ³w**  | Bezpieczne IPC z `contextBridge`                 | Standardowa, bezpieczna metoda komunikacji miÄ™dzy `main` a `renderer`.                    |
| **ZarzÄ…dzanie stanem UI** | Wbudowane hooki React (`useState`, `useContext`) | WystarczajÄ…ce dla prostoty obecnych okien, unikanie nadmiarowych zaleÅ¼noÅ›ci.              |
