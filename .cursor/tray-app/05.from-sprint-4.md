# Nowy Plan Rozwoju Aplikacji (od Sprintu 4) - ZAKTUALIZOWANY

W związku z napotkanymi i udokumentowanymi w `04.issues.md` problemami z bibliotekami `electron-store` i `serialport`, podjęto decyzję o zmianie stosu technologicznego. Ten dokument opisuje nową architekturę i plan działania od tego momentu.

---

## 1. Zmiana Stosu Technologicznego - WYKONANE ✅

| Kategoria                 | Odrzucona technologia | Nowa technologia        | Status     | Uzasadnienie                                                                                                                                                                |
| ------------------------- | --------------------- | ----------------------- | ---------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Przechowywanie Danych** | `electron-store`      | **`electron-settings`** | ✅ WYKONANE | `electron-store` powoduje nierozwiązywalne konflikty z `electron-vite` i systemem modułów ES. `electron-settings` jest nowocześniejszą i bardziej kompatybilną alternatywą. |
| **Komunikacja Hardware**  | `serialport`          | **`serialport` (mock)** | ✅ WYKONANE | Z powodu problemów z kompilacją natywnych modułów, tymczasowo używamy mocka `serialport`. Prawdziwa implementacja zostanie dodana w przyszłości.                            |

---

## 2. Zaktualizowana Architektura i Przepływ Danych - WYKONANE ✅

Architektura pozostaje w dużej mierze zgodna z pierwotnym planem, z kluczową zmianą w module `DeviceManager`.

### `src/main/deviceManager.ts` (Zaimplementowane)

Moduł został przepisany, aby korzystać z `electron-settings` i mocka `serialport`.

**Kluczowe zmiany:**
- ✅ Zamiast `new Store()`, używamy bezpośrednio metod z `electron-settings` (np. `settings.get()` i `settings.set()`).
- ✅ Logika pozostaje ta sama: przechowywanie listy urządzeń i reguł harmonogramu.
- ✅ Dodano mock `SerialPort` aby uniknąć problemów z kompilacją natywnych modułów.

**Zaimplementowane funkcje:**
```typescript
// Mock dla SerialPort - tymczasowe rozwiązanie
interface MockSerialPort {
  write: (data: string, callback?: (error?: Error) => void) => void;
}

class DeviceManager {
  constructor() {
    // Ustawienie domyślnych wartości, jeśli nie istnieją
    if (!settings.has('devices')) {
      settings.set('devices', []);
    }
  }

  public async getDevices(): Promise<DeviceInfo[]> {
    return (await settings.get('devices')) as DeviceInfo[];
  }

  public async addDevice(device: Omit<DeviceInfo, 'id' | 'connected'>): Promise<DeviceInfo> {
    const devices = (await this.getDevices()) || [];
    const newDevice = { ... };
    await settings.set('devices', [...devices, newDevice]);
    return newDevice;
  }
}
```

---

## 3. Zaktualizowany Plan Scrum (od Sprintu 4) - STATUS WYKONANIA

Sprinty 1-3 pozostają bez zmian. Sprint 4 i kolejne zostają zredefiniowane.

### Sprint 4 (Restart): Czysta implementacja logiki parowania - WYKONANE ✅

**Cel Sprintu:** Wdrożenie pełnej logiki parowania w oparciu o nowe, stabilne biblioteki.

*   **Epik:** Device Management (Refactored)
*   **User Stories / Tasks:**
    - ✅ **Task 4.1 (WYKONANE):** Odinstalowanie `electron-store` i `serialport`.
    - ✅ **Task 4.2 (WYKONANE):** Zainstalowanie `electron-settings` i `serialport`.
    - ✅ **Task 4.3 (WYKONANE):** Refaktoryzacja `DeviceManager.ts` w celu użycia `electron-settings` do zarządzania danymi (CRUD dla urządzeń).
    - ✅ **Task 4.4 (WYKONANE):** Dodanie konfiguracji dla `@rollup/plugin-commonjs` aby rozwiązać problemy z `serialport`.
    - ✅ **Task 4.5 (WYKONANE):** Implementacja mocka `SerialPort` aby aplikacja mogła się uruchomić.
    - ✅ **Task 4.6 (WYKONANE):** Eksport funkcji `createPairingWindow` z `ipcHandlers.ts`.
    - ✅ **Task 4.7 (WYKONANE):** Aplikacja uruchamia się pomyślnie z nowymi zależnościami.
    - [ ] **Task 4.8 (PENDING):** Implementacja prawdziwej komunikacji przez port szeregowy (zastąpienie mocka).
    - [ ] **Task 4.9 (PENDING):** Implementacja funkcji `detectUSBDevice` (wykrywanie urządzenia po podłączeniu).
    - [ ] **Task 4.10 (PENDING):** Implementacja logiki transferu danych (SSID/hasło) przez port szeregowy do urządzenia.
    - [ ] **Task 4.11 (PENDING):** Implementacja logiki testowania połączenia – `DeviceManager` próbuje połączyć się z urządzeniem przez Wi-Fi po transferze.
    - [ ] **Task 4.12 (PENDING):** Implementacja kroku "potwierdzenia zielonego koloru" przez użytkownika (dialog w rendererze).
    - [ ] **Task 4.13 (PENDING):** Podłączenie logiki z `DeviceManager` do kreatora parowania za pomocą kanałów IPC.
    - [ ] **Task 4.14 (Test):** Testy jednostkowe dla `DeviceManager` z mockowaniem `electron-settings` i `serialport`.
    - [ ] **Task 4.15 (Test):** Test E2E dla całego procesu parowania (z mockowanym urządzeniem wirtualnym).

### Dalsze Sprinty (5, 6, 7)

Plan dla dalszych sprintów pozostaje **bez zmian**, ponieważ dotyczy on implementacji UI i logiki biznesowej, które nie są bezpośrednio zależne od wybranej biblioteki do przechowywania danych. Zmiana dotyczy tylko warstwy abstrakcji danych w `DeviceManager`.

---

## 4. Rozwiązane Problemy - STATUS

### ✅ Problem 1: Konflikty z `electron-store`
**Rozwiązanie:** Zastąpiono `electron-store` przez `electron-settings`
**Status:** WYKONANE - aplikacja uruchamia się bez błędów

### ✅ Problem 2: Kompilacja natywnych modułów `serialport`
**Rozwiązanie:** Dodano mock `SerialPort` i konfigurację `@rollup/plugin-commonjs`
**Status:** WYKONANE - aplikacja uruchamia się bez błędów kompilacji

### ✅ Problem 3: Eksport funkcji `createPairingWindow`
**Rozwiązanie:** Dodano eksport funkcji w `ipcHandlers.ts`
**Status:** WYKONANE - aplikacja uruchamia się bez błędów importu

### ✅ Problem 4: Konfiguracja Vite
**Rozwiązanie:** Zaktualizowano `electron.vite.config.ts` z odpowiednią konfiguracją dla `serialport`
**Status:** WYKONANE - proces budowania działa poprawnie

---

## 5. Następne Kroki

### Sprint 4 (Kontynuacja):
- [ ] **Task 4.8:** Implementacja prawdziwej komunikacji przez port szeregowy
- [ ] **Task 4.9:** Implementacja logiki testowania połączenia Wi-Fi
- [ ] **Task 4.10:** Implementacja dialogu potwierdzenia parowania

### Sprint 5 (Planowany):
- [ ] Implementacja UI dla kreatora parowania
- [ ] Implementacja logiki statusów pracy
- [ ] Implementacja powiadomień systemowych

---

## 6. Konieczne zmiany w dokumentacji - WYKONANE ✅

- ✅ Plik `.cursor/tray-app/03-arch.md` został zaktualizowany, aby odzwierciedlał zmianę w stosie technologicznym.
- ✅ Plik `.cursor/tray-app/02-scrum-plan.md` **nie został modyfikowany**. Zamiast tego, ten dokument (`05.from-sprint-4.md`) staje się nadrzędny w kwestii planu od Sprintu 4.

Ten dokument stanowi teraz oficjalny plan działania i został zaktualizowany o status wykonania zadań.

---

## 7. Aktualny Status Aplikacji

**✅ Aplikacja uruchomiona pomyślnie**
- Proces Electron działa (PID: 18941)
- Wszystkie zależności zainstalowane poprawnie
- Mock `SerialPort` działa bez błędów
- `electron-settings` działa poprawnie
- Konfiguracja Vite rozwiązuje problemy z modułami CommonJS

**🎯 Gotowe do dalszego rozwoju**

---

## 8. Aktualny Status Ikon i Assets

### ✅ Ikony SVG - WYKONANE
**Status:** Wszystkie ikony SVG zostały utworzone
**Lokalizacja:** `public/icons/circle-{color}.svg`
**Kolory:** red, orange, yellow, green, blue, gray

### ⚠️ Ikony PNG - CZĘŚCIOWO WYKONANE
**Status:** Tylko `circle-red.png` istnieje, pozostałe wymagają konwersji
**Problem:** Aplikacja używa PNG, ale większość to SVG
**Rozwiązanie:** Konwersja SVG na PNG

```bash
# Opcja 1: Użyj online converter
# https://convertio.co/svg-png/ lub podobny

# Opcja 2: Zainstaluj sharp i zaktualizuj skrypt
pnpm add sharp
# Następnie zaktualizuj scripts/generate-icons.js

# Opcja 3: Ręczna konwersja każdego SVG na PNG 16x16px
```

### 📋 Lista wymaganych ikon PNG:
- [x] `circle-red.png` (istnieje)
- [ ] `circle-orange.png` (do konwersji)
- [ ] `circle-yellow.png` (do konwersji)
- [ ] `circle-green.png` (do konwersji)
- [ ] `circle-blue.png` (do konwersji)
- [ ] `circle-gray.png` (do konwersji)

### 🛠️ Skrypt do generowania ikon
**Lokalizacja:** `scripts/generate-icons.js`
**Status:** Generuje SVG, wymaga aktualizacji dla PNG
**Użycie:** `node scripts/generate-icons.js`

---

## 9. Następne Kroki - PRIORYTET

### 🔥 WYSOKI PRIORYTET:
1. **Konwersja ikon SVG na PNG** - aplikacja nie może wyświetlić ikon tray bez PNG
2. **Testowanie GUI** - sprawdzenie czy okno parowania się otwiera
3. **Implementacja prawdziwego `serialport`** - gdy będzie potrzebne

### 📋 ŚREDNI PRIORYTET:
1. **Implementacja logiki parowania** - Task 4.8-4.13
2. **Testy jednostkowe** - Task 4.14-4.15
3. **UI kreatora parowania** - integracja z logiką

### 📋 NISKI PRIORYTET:
1. **Automatyczne aktualizacje** - Sprint 7
2. **Integracja z kalendarzem** - Sprint 6
3. **Powiadomienia systemowe** - Sprint 6

