# Problem z integracją `electron-store` w środowisku Electron + Vite + TypeScript

Podczas implementacji `DeviceManager.ts` w ramach Sprintu 4 napotkano na uporczywy i trudny do zdiagnozowania problem z typami TypeScript dla biblioteki `electron-store`. Mimo że biblioteka została dodana do projektu poprawnie, linter zgłaszał błędy uniemożliwiające korzystanie z jej podstawowych metod (`get` i `set`).

Poniżej znajduje się chronologiczny zapis podjętych prób rozwiązania problemu.

---

## Opis Problemu

Po zaimplementowaniu klasy `DeviceManager` i zainicjalizowaniu w niej `electron-store`, pojawiły się następujące błędy lintera:

```
Property 'get' does not exist on type 'ElectronStore<StoreSchema>'.
Property 'set' does not exist on type 'ElectronStore<StoreSchema>'.
```

Błędy te sugerowały, że TypeScript nie jest w stanie poprawnie rozpoznać metod instancji klasy `Store`, traktując ją jako obiekt bez tych metod.

---

## Historia Prób Rozwiązania

### Podejście 1: Podstawowa implementacja

- **Akcja:** Stworzono plik `deviceManager.ts` z użyciem standardowego importu `import Store from 'electron-store';` i podstawowej logiki odczytu/zapisu.
- **Problem:** Wystąpiły wyżej wymienione błędy lintera.

### Podejście 2: Zmiana składni importu na `require`

- **Hipoteza:** Problem leży w niekompatybilności między modułami ES (używanymi w projekcie) a CommonJS (format `electron-store`).
- **Akcja:** Zmieniono import na `import Store = require('electron-store');`.
- **Wynik:** **Porażka.** Pojawiły się nowe, bardziej fundamentalne błędy: `Import assignment cannot be used when targeting ECMAScript modules.`. To potwierdziło, że konfiguracja projektu oczekuje modułów ES.

### Podejście 3: Modyfikacja `tsconfig.json` (`esModuleInterop`)

- **Hipoteza:** Kluczowym brakującym elementem jest flaga `esModuleInterop: true`, która ułatwia współpracę między różnymi typami modułów.
- **Akcja:** W pliku `tray-app/tsconfig.json` zmieniono wartość `esModuleInterop` z `false` na `true`. Przywrócono pierwotny kod w `deviceManager.ts`.
- **Wynik:** **Porażka.** Mimo kluczowej zmiany w konfiguracji, te same błędy (`Property 'get' does not exist...`) nadal występowały. To było bardzo nieoczekiwane i wskazywało na głębszy problem.

### Podejście 4: Modyfikacja `tsconfig.node.json` (`module`)

- **Hipoteza:** Skoro problem dotyczy procesu `main`, który jest środowiskiem Node.js, jego konfiguracja w `tsconfig.node.json` jest nadrzędna. Ustawienie `"module": "ESNext"` jest prawdopodobnie nieprawidłowe dla biblioteki CommonJS.
- **Akcja:** W pliku `tray-app/tsconfig.node.json` zmieniono `"module": "ESNext"` na `"module": "CommonJS"`. To powinno było ostatecznie rozwiązać problem.
- **Wynik:** **Porażka.** Po raz kolejny, mimo zastosowania teoretycznie poprawnej konfiguracji dla środowiska Node.js w Electronie, błędy lintera pozostały niezmienione.

---

## Wnioski i Status Obecny

Wszystkie standardowe metody rozwiązywania problemów z interoperacyjnością modułów w TypeScript zawiodły. Problem wydaje się specyficzny dla kombinacji narzędzi użytych w projekcie: **Electron + Vite + TypeScript + `electron-store`**.

Możliwe przyczyny:
1.  **Konflikt w narzędziach budowania:** `electron-vite` może w specyficzny sposób przetwarzać importy, co prowadzi do problemów z typami dla niektórych bibliotek.
2.  **Problem z definicją typów w `electron-store`:** Sama biblioteka może mieć wadliwe lub niekompatybilne z tym setupem definicje typów.
3.  **Złożona konfiguracja TypeScript:** Być może istnieje inna opcja w plikach `tsconfig`, która powoduje ten konflikt.

**Status:** **Zablokowano.** Nie można kontynuować implementacji logiki zapisu stanu aplikacji. Należy podjąć decyzję o dalszych krokach:
- Poszukać alternatywnej biblioteki do przechowywania danych (np. `electron-json-storage`).
- Przeprowadzić głębszy research w poszukiwaniu podobnych problemów zgłaszanych przez społeczność dla tej konkretnej kombinacji technologii.
- Poprosić o pomoc zewnętrzną.

---

## Analiza Wyników Wyszukiwania (Research)

Po przeanalizowaniu wyników wyszukiwania dla frazy `electron-vite electron-store typescript type error commonjs`, znaleziono kilka kluczowych wątków, które rzucają nowe światło na problem:

1.  **`electron-vite` używa `Rollup.js` pod spodem:** Kluczową informacją jest to, że `electron-vite` wykorzystuje `Rollup.js` jako domyślny bundler dla procesu głównego (`main`).
2.  **`Rollup.js` ma problemy z modułami CommonJS:** `Rollup` jest natywnie zaprojektowany do pracy z modułami ES (`import`/`export`). Domyślnie nie potrafi on poprawnie przetwarzać zależności w formacie CommonJS (`require`/`module.exports`), do których należy `electron-store`.
3.  **Błąd `[ERR_REQUIRE_ESM]` jest powszechny:** Wiele zgłoszeń na GitHubie (zarówno w repozytorium Electron, jak i Vite) opisuje ten sam mylący błąd. Często jest on wynikiem tego, że bundler (Vite/Rollup) próbuje nieprawidłowo przetworzyć moduł, transpilując `import` na `require` w niekompatybilny sposób.
4.  **Rozwiązaniem jest wtyczka `@rollup/plugin-commonjs`:** Oficjalna dokumentacja `Rollup` oraz liczne wątki na forach wskazują, że rozwiązaniem tego problemu jest dodanie i skonfigurowanie wtyczki `@rollup/plugin-commonjs`. Uczy ona `Rollup`, jak poprawnie interpretować i dołączać do paczki moduły CommonJS.

## Nowa Hipoteza i Plan Działania

**Hipoteza:** Problem nie leży w konfiguracji `tsconfig.json`, ale w konfiguracji narzędzia budującego (`electron-vite`/`Rollup`), które nie zostało poinstruowane, jak obsługiwać zależności CommonJS takie jak `electron-store`.

**Plan działania:**
1.  Zainstalować wtyczkę `@rollup/plugin-commonjs`.
2.  Zmodyfikować plik konfiguracyjny `electron.vite.config.ts`, aby dołączyć tę wtyczkę do `rollupOptions` dla procesu `main`.
3.  Sprawdzić, czy po tej zmianie błędy lintera w `deviceManager.ts` zniknęły.

---

### Podejście 5: Precyzyjna konfiguracja `tsconfig` dla izolacji procesów

- **Hipoteza:** Po zaimplementowaniu `electron.vite.config.ts`, błędy lintera nie zniknęły. Nowa hipoteza zakładała, że serwer językowy TypeScript w edytorze nie używa właściwego pliku `tsconfig` (`tsconfig.node.json` z `module: CommonJS`) do analizy plików w `src/main`, przez co nadal błędnie interpretuje moduły.
- **Akcja 1:** Stworzono plik `electron.vite.config.ts` z wtyczką `@rollup/plugin-commonjs`. Zainstalowano brakujące zależności (`electron-vite`, `@vitejs/plugin-react`).
- **Akcja 2:** Zmodyfikowano `tsconfig.node.json`, aby jego sekcja `include` jawnie obejmowała tylko proces główny i współdzielony: `["electron.vite.config.ts", "src/main/**/*.ts", "src/preload/**/*.ts", "src/shared/**/*.ts"]`.
- **Akcja 3:** Zmodyfikowano główny `tsconfig.json`, aby `include` obejmowało tylko renderer, a sekcja `exclude` jawnie wykluczała proces główny.
- **Wynik:** **Totalna porażka.** Mimo stworzenia podręcznikowej, odizolowanej konfiguracji TypeScript dla każdego z procesów (main i renderer), linter wciąż zgłasza te same, fundamentalne błędy w pliku `deviceManager.ts`: `Cannot find module 'serialport'` oraz `Property 'get' does not exist on type 'ElectronStore<StoreSchema>'`.

---

## Ostateczne Wnioski i Status Obecny

Wyczerpano wszystkie znane i standardowe metody konfiguracji TypeScript oraz narzędzi budujących. Problem leży w fundamentalnej niekompatybilności lub błędzie w którymś z narzędzi (`electron-vite`, `TypeScript Language Server`, `electron-forge`), który uniemożliwia poprawną analizę statyczną plików procesu głównego w tym konkretnym środowisku.

**Status:** **Twarde zablokowanie.** Prace nad Sprintem 4 nie mogą być kontynuowane. Konieczna jest zewnętrzna pomoc lub zmiana kluczowych technologii.
