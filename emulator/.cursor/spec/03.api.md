# Device Mock - API Documentation

## ðŸ”Œ API Reference

### DeviceMock Class

#### Constructor
```typescript
new DeviceMock(options: DeviceMockOptions): DeviceMock
```

**Options:**
```typescript
interface DeviceMockOptions {
  port?: number;           // WebSocket port (default: 8080)
  serialPort?: string;     // Serial port path (default: '/dev/ttyUSB0')
  testMode?: boolean;      // Test mode flag (default: false)
  debug?: boolean;         // Debug mode flag (default: false)
  batteryLevel?: number;   // Initial battery level (default: 100)
  charging?: boolean;      // Charging state (default: false)
}
```

#### Methods

##### start()
```typescript
async start(): Promise<void>
```
Uruchamia mock urzÄ…dzenia.

##### stop()
```typescript
async stop(): Promise<void>
```
Zatrzymuje mock urzÄ…dzenia.

##### getStatus()
```typescript
getStatus(): DeviceStatus
```
Zwraca aktualny stan urzÄ…dzenia.

```typescript
interface DeviceStatus {
  connected: boolean;
  batteryLevel: number;
  charging: boolean;
  ledColor: string;
  ledBrightness: number;
  lastActivity: Date;
}
```

### LEDController Class

#### setColor()
```typescript
setColor(color: string): void
```
Ustawia kolor LED.

**Parameters:**
- `color`: string - Kolor w formacie HEX (#FF0000) lub nazwa

#### setBrightness()
```typescript
setBrightness(level: number): void
```
Ustawia jasnoÅ›Ä‡ LED.

**Parameters:**
- `level`: number - JasnoÅ›Ä‡ (0-100)

#### setPattern()
```typescript
setPattern(pattern: LEDPattern): void
```
Ustawia wzÃ³r animacji LED.

**Parameters:**
- `pattern`: LEDPattern - WzÃ³r animacji

```typescript
interface LEDPattern {
  type: 'solid' | 'breathing' | 'pulse' | 'blink';
  color: string;
  brightness: number;
  speed?: number;
}
```

#### getStatus()
```typescript
getStatus(): LEDStatus
```
Zwraca aktualny stan LED.

```typescript
interface LEDStatus {
  color: string;
  brightness: number;
  pattern: LEDPattern;
  animated: boolean;
}
```

### WiFiManager Class

#### start()
```typescript
async start(): Promise<void>
```
Uruchamia serwer WebSocket.

#### stop()
```typescript
async stop(): Promise<void>
```
Zatrzymuje serwer WebSocket.

#### broadcast()
```typescript
broadcast(message: any): void
```
WysyÅ‚a wiadomoÅ›Ä‡ do wszystkich klientÃ³w.

#### sendToClient()
```typescript
sendToClient(clientId: string, message: any): void
```
WysyÅ‚a wiadomoÅ›Ä‡ do konkretnego klienta.

#### getConnectedClients()
```typescript
getConnectedClients(): string[]
```
Zwraca listÄ™ ID poÅ‚Ä…czonych klientÃ³w.

### ButtonHandler Class

#### handlePress()
```typescript
handlePress(type: 'single' | 'long' | 'double'): void
```
ObsÅ‚uguje naciÅ›niÄ™cie przycisku.

#### setPressCallback()
```typescript
setPressCallback(callback: (type: string) => void): void
```
Ustawia callback dla naciÅ›niÄ™Ä‡ przycisku.

### TestController Class (Test Mode)

#### pressButton()
```typescript
async pressButton(type: 'single' | 'long' | 'double'): Promise<void>
```
Symuluje naciÅ›niÄ™cie przycisku w trybie testowym.

#### receiveSerialData()
```typescript
async receiveSerialData(data: WiFiCredentials): Promise<void>
```
Symuluje odbiÃ³r danych przez port szeregowy.

#### sendAskToEnterRequest()
```typescript
async sendAskToEnterRequest(urgency: 'normal' | 'urgent'): Promise<void>
```
WysyÅ‚a Å¼Ä…danie "Ask to Enter" do tray app.

#### getLEDStatus()
```typescript
async getLEDStatus(): Promise<{ color: string; brightness: number }>
```
Zwraca aktualny stan LED.

#### getLastResponse()
```typescript
async getLastResponse(): Promise<'yes' | 'no' | 'if_urgent'>
```
Zwraca ostatniÄ… odpowiedÅº na Å¼Ä…danie "Ask to Enter".

## ðŸ“¡ WebSocket API (Version 1.0)

### Connection & Authentication

1.  **Handshake**: Upon connecting, the device MUST send a `handshake` message.
2.  **Authentication**: The handshake message includes a `token` that was obtained during the pairing process. The Tray App will disconnect any client that provides an invalid token.
3.  **Versioning**: The `apiVersion` field ensures that the Tray App can support different versions of the device firmware/emulator in the future.

### Message Types

#### Handshake (Device â†’ Tray App)
**Sent once upon connection.**
```typescript
{
  "type": "handshake",
  "deviceId": string,
  "token": string,         // Unique token from pairing process
  "apiVersion": "1.0"
}
```

#### Status Update (Tray App â†’ Device)
```typescript
{
  type: 'status_update';
  status: WorkStatus;
  timestamp: number;
}
```

#### Ask to Enter Request (Device â†’ Tray App)
```typescript
{
  type: 'ask_to_enter';
  deviceId: string;
  urgency: 'normal' | 'urgent';
  timestamp: number;
}
```

#### Ask to Enter Response (Tray App â†’ Device)
```typescript
{
  type: 'ask_to_enter_response';
  deviceId: string;
  response: 'yes' | 'no' | 'if_urgent';
  timestamp: number;
}
```

#### Battery Report (Device â†’ Tray App)
```typescript
{
  type: 'battery_report';
  deviceId: string;
  level: number;
  charging: boolean;
  timestamp: number;
}
```

## ðŸ”§ Serial API

### Data Format
```typescript
interface SerialData {
  type: 'wifi_credentials' | 'connection_test' | 'pairing_status';
  data: WiFiCredentials | ConnectionTest | PairingStatus;
}
```

### WiFi Credentials
```typescript
interface WiFiCredentials {
  ssid: string;
  password: string;
  security: 'WPA2' | 'WPA3' | 'OPEN';
}
```

### Connection Test
```typescript
interface ConnectionTest {
  success: boolean;
  signalStrength?: number;
  error?: string;
}
```

### Pairing Status
```typescript
interface PairingStatus {
  status: 'connecting' | 'connected' | 'failed';
  message: string;
}
```

## ðŸŽ¯ Usage Examples

### Basic Usage
```typescript
import { DeviceMock } from './src/main/deviceMock';

const mock = new DeviceMock({
  port: 8080,
  testMode: false,
  debug: true
});

await mock.start();
```

### Test Mode Usage
```typescript
import { DeviceMock } from './src/main/deviceMock';

const mock = new DeviceMock({
  port: 8080,
  testMode: true,
  debug: true
});

await mock.start();

// Symulacja naciÅ›niÄ™cia przycisku
await mock.testController.pressButton('single');

// Symulacja odbioru danych WiFi
await mock.testController.receiveSerialData({
  ssid: 'TestWiFi',
  password: 'test123',
  security: 'WPA2'
});
```

### LED Control
```typescript
const led = mock.ledController;

// Ustaw kolor
led.setColor('#FF0000');

// Ustaw jasnoÅ›Ä‡
led.setBrightness(80);

// Ustaw wzÃ³r animacji
led.setPattern({
  type: 'breathing',
  color: '#00FF00',
  brightness: 100,
  speed: 1000
});
```

### WebSocket Communication
```typescript
const wifi = mock.wifiManager;

// WysyÅ‚anie wiadomoÅ›ci
wifi.broadcast({
  type: 'battery_report',
  deviceId: 'device-1',
  level: 85,
  charging: false,
  timestamp: Date.now()
});
```

## ðŸš¨ Error Handling

### Common Errors

#### Connection Error
```typescript
try {
  await mock.start();
} catch (error) {
  if (error.code === 'EADDRINUSE') {
    console.error('Port 8080 is already in use');
  }
}
```

#### Serial Communication Error
```typescript
try {
  await mock.serialUtils.write(data);
} catch (error) {
  console.error('Serial communication failed:', error.message);
}
```

#### WebSocket Error
```typescript
wifi.on('error', (error) => {
  console.error('WebSocket error:', error.message);
});
```
