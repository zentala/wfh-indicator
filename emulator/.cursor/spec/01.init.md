# Device Mock Specification - WFH Indicator Emulator

## 🎯 Cel Projektu

Stworzenie mocka urządzenia LED dla aplikacji WFH Indicator, który będzie symulował zachowanie prawdziwego urządzenia ESP32 + WS2812B LED ring. Mock będzie używany do testowania komunikacji między tray app a urządzeniem bez potrzeby posiadania prawdziwego hardware.

## 🏗️ Architektura Mocka

### Struktura Projektu
```
emulator/
├── src/
│   ├── main/
│   │   ├── deviceMock.ts      # Główna logika mocka
│   │   ├── ledController.ts    # Symulacja LED ring
│   │   ├── buttonHandler.ts    # Symulacja przycisku fizycznego
│   │   └── wifiManager.ts      # Symulacja WiFi komunikacji
│   ├── types/
│   │   └── deviceTypes.ts      # Typy TypeScript
│   └── utils/
│       ├── colorUtils.ts       # Konwersje kolorów
│       └── serialUtils.ts      # Symulacja komunikacji szeregowej
├── tests/
│   ├── unit/
│   └── integration/
├── package.json
├── tsconfig.json
└── README.md
```

## 📋 Wymagania Funkcjonalne

### 1. Symulacja LED Ring
- **Status Colors**: Red, Orange, Yellow, Green, Blue, Gray
- **Animation**: Smooth transitions between colors
- **Brightness**: Simulated brightness levels (0-100%)
- **Patterns**: Breathing effect, pulse, solid

### 2. Symulacja Przycisku Fizycznego
- **Ask to Enter**: Single press triggers "Ask to Enter" request
- **Long Press**: Reset device/enter pairing mode
- **Double Press**: Toggle brightness
- **Visual Feedback**: LED blinks when button pressed

### 3. Komunikacja WiFi
- **WebSocket Server**: Listens for status updates from tray app
- **Status Sync**: Receives and displays current work status
- **Ask to Enter**: Sends requests to tray app
- **Battery Level**: Reports simulated battery level every 5 minutes

### 4. Komunikacja Serial (Pairing)
- **SSID/Password**: Receives WiFi credentials during pairing
- **Connection Test**: Simulates connection test
- **Pairing Confirmation**: Green LED confirmation

## 🔧 Specyfikacja Techniczna

### Stack Technologiczny
- **Language**: TypeScript
- **Package Manager**: pnpm
- **Testing**: Jest + @types/jest
- **Documentation**: JSDoc
- **Linting**: ESLint + Prettier

### Dependencies
```json
{
  "dependencies": {
    "ws": "^8.14.2",           // WebSocket server
    "serialport": "^12.0.0",    // Serial communication
    "chalk": "^5.3.0"          // Console colors
  },
  "devDependencies": {
    "@types/ws": "^8.5.10",
    "@types/jest": "^29.5.8",
    "jest": "^29.7.0",
    "typescript": "^5.2.2",
    "eslint": "^8.55.0",
    "prettier": "^3.1.0"
  }
}
```

## 🎨 Status System

### Work Status Colors
```typescript
enum WorkStatus {
  ON_CALL = 'red',      // 🔴 Audio/video calls
  VIDEO_CALL = 'orange', // 🟠 Video calls only
  FOCUSED = 'yellow',    // 🟡 Deep work
  AVAILABLE = 'green',   // 🟢 Available
  AWAY = 'blue',         // 🔵 Not at desk
  OFFLINE = 'gray'       // ⚫ Device offline
}
```

### LED Patterns
```typescript
interface LEDPattern {
  type: 'solid' | 'breathing' | 'pulse' | 'blink';
  color: string;
  brightness: number; // 0-100
  speed?: number;     // Animation speed
}
```

## 🔌 API Komunikacji

### WebSocket Messages (Tray App ↔ Device)
```typescript
// Status Update from Tray App
interface StatusUpdate {
  type: 'status_update';
  status: WorkStatus;
  timestamp: number;
}

// Ask to Enter Request from Device
interface AskToEnterRequest {
  type: 'ask_to_enter';
  deviceId: string;
  urgency: 'normal' | 'urgent';
  timestamp: number;
}

// Ask to Enter Response from Tray App
interface AskToEnterResponse {
  type: 'ask_to_enter_response';
  deviceId: string;
  response: 'yes' | 'no' | 'if_urgent';
  timestamp: number;
}

// Battery Level Report from Device
interface BatteryReport {
  type: 'battery_report';
  deviceId: string;
  level: number; // 0-100
  charging: boolean;
  timestamp: number;
}
```

### Serial Communication (Pairing)
```typescript
// WiFi Credentials during Pairing
interface WiFiCredentials {
  ssid: string;
  password: string;
  security: 'WPA2' | 'WPA3' | 'OPEN';
}

// Pairing Status
interface PairingStatus {
  status: 'connecting' | 'connected' | 'failed';
  message: string;
}
```

## 🧪 Plan Testowania

### Unit Tests
- **LED Controller**: Color transitions, patterns, brightness
- **Button Handler**: Press detection, timing, debouncing
- **WiFi Manager**: WebSocket communication, message handling
- **Serial Utils**: Pairing simulation, data encoding

### Integration Tests
- **Full Pairing Flow**: Serial → WiFi → Status sync
- **Ask to Enter Flow**: Button press → Request → Response
- **Status Update Flow**: Tray app → Device → LED display
- **Battery Simulation**: Level changes, charging states

### E2E Tests
- **Complete Workflow**: Pairing → Status updates → Ask to enter → Response
- **Error Handling**: Network disconnection, invalid data, timeout scenarios
- **Performance**: Multiple rapid status changes, concurrent requests

## 🚀 Implementacja

### Phase 1: Core Mock (Week 1)
- [ ] Basic LED simulation with console output
- [ ] WebSocket server for status updates
- [ ] Simple button simulation (keyboard input)
- [ ] Basic serial communication simulation

### Phase 2: Advanced Features (Week 2)
- [ ] LED patterns and animations
- [ ] Ask to Enter functionality
- [ ] Battery level simulation
- [ ] Error handling and recovery

### Phase 3: Testing & Polish (Week 3)
- [ ] Comprehensive test suite
- [ ] Documentation and examples
- [ ] Performance optimization
- [ ] Integration with tray app

## 📊 Success Metrics

### Technical Metrics
- **Test Coverage**: >90% for core functionality
- **Performance**: <100ms response time for status updates
- **Reliability**: 99.9% uptime during testing sessions
- **Compatibility**: Works with current tray app without modifications

### Development Metrics
- **Code Quality**: ESLint score >95%
- **Documentation**: JSDoc coverage for all public APIs
- **Maintainability**: Clear separation of concerns, modular design

## 🔮 Future Enhancements

### Potential Extensions
- **GUI Interface**: Visual LED ring simulation
- **Multiple Devices**: Support for multiple mock devices
- **Network Simulation**: WiFi interference, packet loss
- **Hardware Emulation**: More realistic ESP32 behavior

### Integration Possibilities
- **Home Assistant**: Integration with smart home systems
- **Mobile App**: Remote control via mobile device
- **Cloud Sync**: Status synchronization across devices
- **Analytics**: Usage patterns and device health monitoring

---

**Note**: This mock will serve as a development and testing tool, allowing developers to work on the tray app without requiring physical hardware. It maintains full compatibility with the existing device communication protocol while providing realistic simulation of device behavior.

## 🔗 Integracja z Testami E2E w Tray App

### 🎯 Cel Integracji

Mock urządzenia jest kluczowy dla ukończenia testów E2E w tray-app, szczególnie dla zadań:
- **Task 4.15**: Test E2E dla procesu parowania
- **Task 6.7**: Test E2E dla "Ask to Enter"

### 🏗️ Architektura Integracji

#### Struktura Testów E2E z Mockiem
```
tray-app/
├── e2e/
│   ├── device-mock/
│   │   ├── mock-server.ts      # Serwer mocka urządzenia
│   │   ├── mock-controller.ts  # API do kontrolowania mocka
│   │   └── mock-scenarios.ts   # Predefiniowane scenariusze
│   ├── tests/
│   │   ├── pairing.spec.ts     # Test parowania
│   │   ├── ask-to-enter.spec.ts # Test powiadomień
│   │   └── status-updates.spec.ts # Test aktualizacji statusu
│   └── utils/
│       └── mock-helper.ts      # Helpery do testów
```

#### Mock Controller API
```typescript
// API do kontrolowania mocka w testach E2E
class MockDeviceController {
  // Symulacja przycisku fizycznego
  async pressButton(type: 'single' | 'long' | 'double'): Promise<void>;

  // Symulacja komunikacji szeregowej
  async receiveSerialData(data: WiFiCredentials): Promise<void>;

  // Symulacja żądania "Ask to Enter"
  async sendAskToEnterRequest(urgency: 'normal' | 'urgent'): Promise<void>;

  // Sprawdzenie stanu LED
  async getLEDStatus(): Promise<{ color: string; brightness: number }>;

  // Sprawdzenie ostatniej odpowiedzi
  async getLastResponse(): Promise<'yes' | 'no' | 'if_urgent'>;
}
```

### 📋 Scenariusze Testowe

#### A. Test Parowania (Task 4.15)
```typescript
test('Complete pairing flow with mock device', async ({ page }) => {
  // 1. Otwórz kreator parowania
  await page.click('[data-testid="add-device"]');

  // 2. Mock odbiera SSID/password przez Serial
  await mockDevice.receiveSerialData({
    ssid: 'TestWiFi',
    password: 'test123'
  });

  // 3. Mock łączy się przez WiFi
  await mockDevice.connectToWiFi();

  // 4. Mock potwierdza parowanie (zielony LED)
  await mockDevice.confirmPairing();

  // 5. Sprawdź czy urządzenie pojawiło się na liście
  await expect(page.locator('[data-testid="device-list"]'))
    .toContainText('LED Device #1');
});
```

#### B. Test "Ask to Enter" (Task 6.7)
```typescript
test('Ask to Enter notification flow', async ({ page }) => {
  // 1. Mock wysyła żądanie "Ask to Enter"
  await mockDevice.sendAskToEnterRequest({
    deviceId: 'device-1',
    urgency: 'normal'
  });

  // 2. Sprawdź czy powiadomienie się pojawiło
  await expect(page.locator('[data-testid="notification"]'))
    .toContainText('Ask to Enter');

  // 3. Kliknij "Yes" w powiadomieniu
  await page.click('[data-testid="notification-yes"]');

  // 4. Sprawdź czy odpowiedź została wysłana do mocka
  await expect(mockDevice.getLastResponse()).toBe('yes');
});
```

### 🔧 Implementacja Techniczna

#### Mock w Trybie Testowym
```typescript
// emulator/src/main/deviceMock.ts
class DeviceMock {
  private testMode: boolean = false;
  private testController: TestController;

  constructor(options: { testMode?: boolean }) {
    this.testMode = options.testMode || false;
    if (this.testMode) {
      this.testController = new TestController();
    }
  }

  // API dla testów E2E
  async simulateButtonPress(type: 'single' | 'long' | 'double'): Promise<void> {
    if (!this.testMode) return;

    switch (type) {
      case 'single':
        await this.sendAskToEnterRequest('normal');
        break;
      case 'long':
        await this.enterPairingMode();
        break;
    }
  }
}
```

#### Integracja z Playwright
```typescript
// tray-app/e2e/utils/mock-helper.ts
export class MockHelper {
  private mockController: MockDeviceController;

  async setupMock(): Promise<void> {
    // Uruchom mock urządzenia
    this.mockController = new MockDeviceController({
      port: 8080,
      serialPort: '/dev/ttyUSB0'
    });
    await this.mockController.start();
  }

  async simulateDeviceAction(action: DeviceAction): Promise<void> {
    switch (action.type) {
      case 'button_press':
        await this.mockController.pressButton(action.buttonType);
        break;
      case 'ask_to_enter':
        await this.mockController.sendAskToEnterRequest(action.urgency);
        break;
    }
  }
}
```

### 📋 Plan Integracji

#### Phase 1: Podstawowa Integracja
- [ ] Mock urządzenia z trybem testowym
- [ ] API do kontrolowania mocka
- [ ] Integracja z Playwright testami
- [ ] Podstawowe scenariusze testowe

#### Phase 2: Zaawansowane Scenariusze
- [ ] Testy parowania z różnymi scenariuszami błędów
- [ ] Testy "Ask to Enter" z różnymi poziomami pilności
- [ ] Testy aktualizacji statusu w czasie rzeczywistym
- [ ] Testy obsługi błędów komunikacji

#### Phase 3: Optymalizacja
- [ ] Automatyzacja uruchamiania mocka w CI/CD
- [ ] Parallel test execution z wieloma mockami
- [ ] Performance testing z symulacją wielu urządzeń

### 🎯 Korzyści z Integracji

1. **Realistyczne Testy** - Mock symuluje prawdziwe zachowanie urządzenia
2. **Kontrola Scenariuszy** - Możemy testować różne sytuacje (błędy, timeouty)
3. **Izolacja Testów** - Nie zależymy od prawdziwego hardware
4. **Szybkie Iteracje** - Testy działają bez fizycznego urządzenia
5. **CI/CD Friendly** - Mock może działać w środowisku CI/CD

### 🔗 Komunikacja z Tray App

#### WebSocket Communication
```typescript
// Mock wysyła status do tray app
await mockDevice.sendStatusUpdate({
  type: 'status_update',
  status: WorkStatus.AVAILABLE,
  timestamp: Date.now()
});

// Mock odbiera status od tray app
mockDevice.onStatusUpdate((status: WorkStatus) => {
  this.ledController.setColor(status);
});
```

#### Serial Communication (Pairing)
```typescript
// Mock odbiera dane WiFi podczas parowania
mockDevice.onSerialData((data: WiFiCredentials) => {
  this.wifiManager.connect(data.ssid, data.password);
});
```

---

**Note**: Ta integracja umożliwia ukończenie wszystkich testów E2E w tray-app bez potrzeby posiadania prawdziwego hardware, jednocześnie zapewniając realistyczne testowanie komunikacji z urządzeniem.
