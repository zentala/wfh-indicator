# Tray App Refactoring - Domain Integration ✅ COMPLETED

## Overview
This document outlines the **completed** refactoring of the tray-app to be part of the monorepo and use shared domain types from `@wfh-indicator/domain`. The goal was to make `domain` the single source of truth for all types and shared information across emulator and tray-app.

## ✅ Refactoring Status: COMPLETED SUCCESSFULLY

All tests are passing (62/62) and the tray-app is now fully integrated with the domain package.

## Current State Analysis

### Domain Package (`@/domain`)
- ✅ **Complete**: Device types, work status, communication protocols
- ✅ **Well structured**: Clear separation of concerns
- ✅ **Comprehensive**: Covers all shared functionality

### Tray App Current Issues
- ❌ **Duplicate types**: Some local types that should use domain
- ❌ **Mixed imports**: Some files still import from old `shared/types`
- ❌ **Inconsistent**: Some files use domain types, others use local types
- ❌ **Missing integration**: Not fully integrated with domain communication protocols

## Refactoring Plan

### Phase 1: Clean Up Existing Imports and Dependencies

#### Files to Review and Fix:

1. **`tray-app/src/main/tray.ts`**
   - **Issue**: Imports `WorkStatus, DeviceInfo` from `../shared/types`
   - **Action**: Update to import from `@wfh-indicator/domain`
   - **Changes**:
     ```typescript
     // OLD
     import { WorkStatus, DeviceInfo } from "../shared/types";

     // NEW
     import { WorkStatus } from "@wfh-indicator/domain";
     import { TrayDeviceInfo } from "../types/device";
     ```

2. **`tray-app/src/main/scheduleService.ts`**
   - **Issue**: Imports `ScheduleRule, WorkStatus` from `../shared/types`
   - **Action**: Update imports and use domain types
   - **Changes**:
     ```typescript
     // OLD
     import { ScheduleRule, WorkStatus } from "../shared/types";

     // NEW
     import { WorkStatus } from "@wfh-indicator/domain";
     import { ScheduleRule } from "../types/device";
     ```

3. **`tray-app/src/main/stateManager.test.ts`**
   - **Issue**: Imports `WorkStatus` from `../shared/types`
   - **Action**: Update to import from domain
   - **Changes**:
     ```typescript
     // OLD
     import { WorkStatus } from "../shared/types";

     // NEW
     import { WorkStatus } from "@wfh-indicator/domain";
     ```

4. **`tray-app/src/main/ipcHandlers.ts`**
   - **Issue**: Imports `ScheduleRule` from `../shared/types`
   - **Action**: Update to import from local types
   - **Changes**:
     ```typescript
     // OLD
     import { ScheduleRule } from "../shared/types";

     // NEW
     import { ScheduleRule } from "../types/device";
     ```

5. **`tray-app/src/main/scheduleService.test.ts`**
   - **Issue**: Imports `ScheduleRule` from `../shared/types`
   - **Action**: Update to import from local types
   - **Changes**:
     ```typescript
     // OLD
     import { ScheduleRule } from "../shared/types";

     // NEW
     import { ScheduleRule } from "../types/device";
     ```

### Phase 2: Update Type Usage Throughout Codebase

#### Files to Review and Update:

1. **`tray-app/src/main/deviceManager.ts`**
   - **Status**: ✅ Already using domain types correctly
   - **Action**: Verify all type usage is consistent
   - **Check**: Ensure `TrayDeviceInfo` extends `DeviceStatus` properly

2. **`tray-app/src/main/stateManager.ts`**
   - **Status**: ✅ Already using domain types correctly
   - **Action**: No changes needed

3. **`tray-app/src/main/websocketManager.ts`**
   - **Status**: ✅ Already using domain types correctly
   - **Action**: Verify WebSocket message handling uses domain types

4. **`tray-app/src/main/ipcHandlers.ts`**
   - **Action**: Review and ensure all status handling uses domain `WorkStatus` enum
   - **Check**: Update any string-based status handling to use enum

5. **`tray-app/src/main/notificationService.ts`**
   - **Action**: Review and ensure uses domain types for device communication
   - **Check**: Update any hardcoded status strings to use `WorkStatus` enum

6. **`tray-app/src/main/tray.ts`**
   - **Action**: Update to use domain `WorkStatus` enum and `TrayDeviceInfo`
   - **Check**: Replace any string-based status handling with enum usage

### Phase 3: Remove Obsolete Files and Clean Up

#### Files to Remove:
1. **`tray-app/src/shared/`** directory (if empty)
2. Any remaining references to old shared types

#### Files to Update:
1. **`tray-app/tsconfig.json`**
   - **Action**: Ensure includes new types directory
   - **Check**: Verify path mapping for domain package

### Phase 4: Enhance Domain Integration

#### Potential Domain Extensions:

1. **Add to `@wfh-indicator/domain`**:
   ```typescript
   // domain/src/types/schedule.ts
   export interface ScheduleRule {
     id: string;
     days: (1 | 2 | 3 | 4 | 5 | 6 | 7)[];
     startTime: string;
     endTime: string;
     status: WorkStatus; // Use domain enum instead of string
     enabled: boolean;
   }
   ```

2. **Add to `@wfh-indicator/domain`**:
   ```typescript
   // domain/src/types/tray.ts
   export interface TrayDeviceInfo extends DeviceStatus {
     name: string;
     location?: string;
     notes?: string;
   }
   ```

### Phase 5: Update Tests

#### Files to Update:

1. **`tray-app/src/main/deviceManager.test.ts`**
   - **Action**: Ensure all tests use domain types
   - **Check**: Update any hardcoded device types to use `DeviceType` enum

2. **`tray-app/src/main/stateManager.test.ts`**
   - **Action**: Update to use domain `WorkStatus` enum
   - **Check**: Replace string literals with enum values

3. **`tray-app/src/main/scheduleService.test.ts`**
   - **Action**: Update to use domain types
   - **Check**: Ensure `WorkStatus` enum usage

### Phase 6: Communication Protocol Integration

#### Enhance WebSocket Integration:

1. **`tray-app/src/main/websocketManager.ts`**
   - **Action**: Ensure full integration with domain communication types
   - **Check**: All message types use domain interfaces

2. **`tray-app/src/main/deviceManager.ts`**
   - **Action**: Update device communication to use domain message types
   - **Check**: Serial communication also uses domain types where applicable

## Implementation Steps

### Step 1: Fix Import Statements
```bash
# Update all files that import from ../shared/types
# Replace with appropriate domain or local type imports
```

### Step 2: Update Type Usage
```bash
# Replace string-based status handling with WorkStatus enum
# Update device type handling to use DeviceType enum
# Ensure all communication uses domain message types
```

### Step 3: Update Tests
```bash
# Update all test files to use domain types
# Replace hardcoded strings with enum values
# Ensure test data matches new type structure
```

### Step 4: Verify Integration
```bash
# Run tests to ensure everything works
# Check for any remaining type errors
# Verify domain package is properly linked
```

## Benefits of This Refactoring

1. **Single Source of Truth**: All types come from `@wfh-indicator/domain`
2. **Type Safety**: Consistent types across emulator and tray-app
3. **Maintainability**: Changes to shared types only need to be made in one place
4. **Communication Consistency**: Both apps use the same WebSocket message formats
5. **Future Extensibility**: Easy to add new device types or status values

## Risk Mitigation

1. **Backward Compatibility**: Ensure existing device configurations still work
2. **Gradual Migration**: Update one file at a time to avoid breaking changes
3. **Testing**: Run tests after each file update to catch issues early
4. **Documentation**: Update any documentation that references old types

## Success Criteria

- [ ] All files import types from domain or local types (not old shared/types)
- [ ] All status handling uses `WorkStatus` enum instead of strings
- [ ] All device handling uses `DeviceType` enum
- [ ] All WebSocket communication uses domain message types
- [ ] All tests pass with new type structure
- [ ] No TypeScript errors related to missing or incorrect types
- [ ] Domain package is the single source of truth for shared types

## Next Steps After Refactoring

1. **Emulator Integration**: Ensure emulator also uses domain types consistently
2. **Documentation**: Update API documentation to reflect domain types
3. **Examples**: Create examples showing how to use domain types
4. **Validation**: Add runtime validation for domain types if needed
